meta {
  name: Google OAuth Verify
  type: http
  seq: 4
}

post {
  url: {{baseUrl}}/api/v1/auth/google/verify
  body: json
  auth: none
}

body:json {
  {
    "id_token": "eyJhbGciOiJSUzI1NiIsImtpZCI6IjExIn0.eyJhdWQiOiI3NTQxMjM0MjI3LWQwZ3MwZnFuYXQ2dDJpNTYwNzc5c2h0YXJmaW5xLmFwcHMuZ29vZ2xldXNlcmNvbnRlbnQuY29tIiwic3ViIjoiMTAyNDQxMzQyNjEzOTM5MTEzMzc1IiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImF6cCI6Ijc1NDEyMzQyMjctZDBnczBmcW5hdDZ0Mmk1NjA3NzlzaHRhcmZpbnEuYXBwcy5nb29nbGV1c2VyY29udGVudC5jb20iLCJuYW1lIjoiSm9obiBEb2UiLCJwaWN0dXJlIjoiaHR0cHM6Ly9saDMuZ29vZ2xldXNlcmNvbnRlbnQuY29tL2EtL0FXSWlGbkZkNXhVSEJYR1J6T1lXM3p1T0Y2SkFJRWVQV3F5RXJCWkxtMXdRPXM2NC1jIiwiZ2l2ZW5fbmFtZSI6IkpvaG4iLCJmYW1pbHlfbmFtZSI6IkRvZSIsImxvY2FsZSI6ImVuIiwiaWF0IjoxNjc2OTAyMDAwLCJleHAiOjE2NzY5MDU2MDB9.Signature"
  }
}

tests {
  test("Status is 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  test("Response has success flag", function() {
    expect(res.getBody().success).to.equal(true);
  });

  test("Response contains user data", function() {
    const body = res.getBody();
    expect(body.data).to.exist;
    expect(body.data.user).to.exist;
    expect(body.data.user.email).to.be.a("string");
  });

  test("User provider is google", function() {
    const body = res.getBody();
    expect(body.data.user.provider).to.equal("google");
  });

  test("Response contains access token", function() {
    const body = res.getBody();
    expect(body.data.access_token).to.be.a("string");
    expect(body.data.access_token.length).to.be.above(0);
  });

  test("Response contains refresh token", function() {
    const body = res.getBody();
    expect(body.data.refresh_token).to.be.a("string");
    expect(body.data.refresh_token.length).to.be.above(0);
  });

  test("User has avatar URL from Google", function() {
    const body = res.getBody();
    expect(body.data.user.avatar_url).to.be.a("string");
  });
}

docs {
  # Google OAuth Token Verification

  ## Description
  Verify Google ID token obtained from frontend Google Sign-In integration. This endpoint handles both new user registration and existing user login via Google OAuth.

  ## Authentication
  None required (public endpoint)

  ## Request Body
  - **id_token** (string, required): Google ID token from Google Sign-In SDK (frontend-initiated)

  ## Flow
  1. User clicks "Sign in with Google" button on frontend
  2. Frontend calls Google Sign-In SDK to get ID token
  3. Frontend sends ID token to this endpoint
  4. Backend verifies token with Google
  5. If user doesn't exist, creates new account
  6. Returns authentication response with tokens

  ## Response (200 OK)
  ```json
  {
    "success": true,
    "data": {
      "user": {
        "id": 2,
        "email": "john.doe@gmail.com",
        "name": "John Doe",
        "provider": "google",
        "avatar_url": "https://lh3.googleusercontent.com/...",
        "is_active": true,
        "created_at": "2026-01-03T10:00:00Z"
      },
      "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "token_type": "Bearer",
      "expires_in": 86400
    }
  }
  ```

  ## Token Details
  - **Access Token**: Valid for 24 hours, use for authenticated requests
  - **Refresh Token**: Valid for 7 days, use to refresh access token
  - **Token Type**: Always "Bearer"

  ## How to Get ID Token
  ### Using Google Sign-In JavaScript SDK
  ```javascript
  // Initialize Google Sign-In
  gapi.signin2.init({
    client_id: 'YOUR_CLIENT_ID.apps.googleusercontent.com'
  });

  // Handle sign-in response
  function onSignIn(googleUser) {
    const profile = googleUser.getBasicProfile();
    const idToken = googleUser.getAuthResponse().id_token;

    // Send to backend
    fetch('/api/v1/auth/google/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id_token: idToken })
    });
  }
  ```

  ## Account Linking
  - If user with same email exists, will link Google provider to existing account
  - User can have multiple authentication methods
  - Profile picture updated from Google if not already set

  ## Error Responses
  - **400 Bad Request**: Invalid request format
  - **401 Unauthorized**: Invalid or expired ID token, failed Google verification
  - **403 Forbidden**: Account is inactive
  - **500 Internal Server Error**: Server error during verification

  ## Example cURL
  ```bash
  curl -X POST http://localhost:8080/api/v1/auth/google/verify \
    -H "Content-Type: application/json" \
    -d '{
      "id_token": "eyJhbGciOiJSUzI1NiIs..."
    }'
  ```

  ## Security
  - ID tokens are verified cryptographically with Google's public keys
  - Tokens expire quickly (typically 1 hour)
  - Never trust token content without verification
}
